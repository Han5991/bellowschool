<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/basic :: setContent(~{this::content} )}">
    <th:block th:fragment="content">
        <link href="css/Fullcalendar.css" rel="stylesheet">

        <div class="container-fluid">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h3 class="m-0 font-weight-bold text-primary">시간표 등록</h3>
                </div>
                <div class="card-body">
                    <div id='wrap'>
                        <div id='external-events'>
                            <h4>풀무야간학교 반</h4>
                            <div id='external-events-list' style="width: 10%">
                                <div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event'
                                     th:each="class : ${classList}">
                                    <div class='fc-event-main'
                                         th:text="${class.classtype} + ' : '+ ${class.starttime}+' ~ '+${class.endtime}"></div>
                                </div>
                            </div>
                        </div>
                        <p>
                            <input type='checkbox' id='drop-remove'/>
                            <label for='drop-remove'>remove after drop</label>
                        </p>
                        <div id='calendar-wrap'>
                            <div id='calendar'></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 일정 추가 MODAL -->
        <div class="modal add" tabindex="-1" role="dialog" id="eventModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title"></h4>
                    </div>
                    <div class="modal-body">

                        <div class="row">
                            <div class="col-xs-12">
                                <label class="col-xs-4" for="edit-allDay">하루종일</label>
                                <input class='allDayNewEvent' id="edit-allDay" type="checkbox"></label>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <label class="col-xs-4" for="edit-title">일정명</label>
                                <input class="inputModal" type="text" name="edit-title" id="edit-title"
                                       required="required" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="col-xs-4" for="edit-start">시작</label>
                                <input class="inputModal" type="text" name="edit-start" id="edit-start" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="col-xs-4" for="edit-end">끝</label>
                                <input class="inputModal" type="text" name="edit-end" id="edit-end" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="col-xs-4" for="edit-type">구분</label>
                                <select class="inputModal" type="text" name="edit-type" id="edit-type">
                                    <option value="카테고리1">카테고리1</option>
                                    <option value="카테고리2">카테고리2</option>
                                    <option value="카테고리3">카테고리3</option>
                                    <option value="카테고리4">카테고리4</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="col-xs-4" for="edit-color">색상</label>
                                <select class="inputModal" name="color" id="edit-color">
                                    <option value="#D25565" style="color:#D25565;">빨간색</option>
                                    <option value="#9775fa" style="color:#9775fa;">보라색</option>
                                    <option value="#ffa94d" style="color:#ffa94d;">주황색</option>
                                    <option value="#74c0fc" style="color:#74c0fc;">파란색</option>
                                    <option value="#f06595" style="color:#f06595;">핑크색</option>
                                    <option value="#63e6be" style="color:#63e6be;">연두색</option>
                                    <option value="#a9e34b" style="color:#a9e34b;">초록색</option>
                                    <option value="#4d638c" style="color:#4d638c;">남색</option>
                                    <option value="#495057" style="color:#495057;">검정색</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12">
                                <label class="col-xs-4" for="edit-desc">설명</label>
                                <textarea rows="4" cols="50" class="inputModal" name="edit-desc"
                                          id="edit-desc"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer modalBtnContainer-addEvent">
                        <button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-primary" id="save-event">저장</button>
                    </div>
                    <div class="modal-footer modalBtnContainer-modifyEvent">
                        <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
                        <button type="button" class="btn btn-danger" id="deleteEvent">삭제</button>
                        <button type="button" class="btn btn-primary" id="updateEvent">저장</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <script src="js/Fullcalendar.js"></script>
        <script>
            function calDateWhenDragnDrop(event) {
                // 드랍시 수정된 날짜반영
                var newDates = {
                    startDate: '',
                    endDate: ''
                }

                // 날짜 & 시간이 모두 같은 경우
                if (!event.end) {
                    event.end = event.start;
                }

                // //하루짜리 all day
                // if (event.allDay && event.end === event.start) {
                //     newDates.startDate = moment(event.start._d).format('YYYY-MM-DD');
                //     newDates.endDate = newDates.startDate;
                // }
                //
                // //2일이상 all day
                // else if (event.allDay && event.end !== null) {
                //     newDates.startDate = moment(event.start._d).format('YYYY-MM-DD');
                //     newDates.endDate = moment(event.end._d).subtract(1, 'days').format('YYYY-MM-DD');
                // }
                //
                // //all day가 아님
                // else if (!event.allDay) {
                //     newDates.startDate = moment(event.start._d).format('YYYY-MM-DD HH:mm');
                //     newDates.endDate = moment(event.end._d).format('YYYY-MM-DD HH:mm');
                // }

                return newDates;
            }

            const containerEl = $('#external-events-list')[0];
            new FullCalendar.Draggable(containerEl, {
                itemSelector: '.fc-event',
                eventData: function (eventEl) {
                    return {
                        title: eventEl.innerText.trim()
                    }
                }
            });

            const calendarEl = $('#calendar')[0];
            const calendar = new FullCalendar.Calendar(calendarEl, {
                locale: "ko",
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                editable: true,
                droppable: true,
                contentHeight: 'auto',
                selectable: true,
                dateClick: function (info) {
                    // console.log(info);
                    // alert('clicked ' + info.dateStr);
                },
                eventClick: function (event, jsEvent, view) {
                    console.log(event.event.start.toISOString());
                    console.log(event.event.end.toISOString());
                },
                select: function (info) {
                    // alert('selected ' + info.startStr + ' to ' + info.endStr);
                    $(".add").modal('show');
                },
                droppable: true, // this allows things to be dropped onto the calendar
                drop: function (arg) {
                    // is the "remove after drop" checkbox checked?
                    if (document.getElementById('drop-remove').checked) {
                        // if so, remove the element from the "Draggable Events" list
                        arg.draggedEl.parentNode.removeChild(arg.draggedEl);
                    }
                },
                events: [{
                    "id": 1,
                    "title": "거래처 미팅",
                    "description": "Lorem ipsum dolor sit incid idunt ut Lorem ipsum sit.",
                    "start": "2021-06-07T09:30",
                    "end": "2021-06-07T15:00",
                    "type": "카테고리1",
                    "username": "다현",
                    "backgroundColor": "#D25565",
                    "textColor": "#ffffff",
                    "allDay": false
                }, {
                    "id": 2,
                    "title": "치과예약",
                    "description": "Lorem ipsum dolor sit incid idunt ut Lorem ipsum sit.",
                    "start": "2021-06-01T12:30",
                    "end": "2021-06-01T15:30",
                    "type": "카테고리1",
                    "username": "나연",
                    "backgroundColor": "#9775fa",
                    "textColor": "#ffffff",
                    "allDay": false
                }, {
                    "id": 3,
                    "title": "철수 생일",
                    "description": "Lorem ipsum dolor sit incid idunt ut Lorem ipsum sit.",
                    "start": "2021-06-12",
                    "end": "2021-06-12",
                    "type": "카테고리2",
                    "username": "다현",
                    "backgroundColor": "#ffa94d",
                    "textColor": "#ffffff",
                    "allDay": true
                }, {
                    "id": 4,
                    "title": "멜론 만기",
                    "description": "Lorem ipsum dolor sit incid idunt ut Lorem ipsum sit.",
                    "start": "2021-06-06",
                    "end": "2021-06-06",
                    "type": "카테고리2",
                    "username": "지효",
                    "backgroundColor": "#74c0fc",
                    "textColor": "#ffffff",
                    "allDay": true
                }, {
                    "id": 5,
                    "title": "청약 입금",
                    "description": "Lorem ipsum dolor sit incid idunt ut Lorem ipsum sit.",
                    "start": "2021-06-08",
                    "end": "2021-06-08",
                    "type": "카테고리3",
                    "username": "지효",
                    "backgroundColor": "#f06595",
                    "textColor": "#ffffff",
                    "allDay": true
                }, {
                    "id": 6,
                    "title": "카드값 납부",
                    "description": "Lorem ipsum dolor sit incid idunt ut Lorem ipsum sit.",
                    "start": "2021-06-14",
                    "end": "2021-06-14",
                    "type": "카테고리2",
                    "username": "사나",
                    "backgroundColor": "#63e6be",
                    "textColor": "#ffffff",
                    "allDay": true
                }, {
                    "id": 7,
                    "title": "휴가",
                    "description": "Lorem ipsum dolor sit incid idunt ut Lorem ipsum sit.",
                    "start": "2021-06-18",
                    "end": "2021-06-20",
                    "type": "카테고리4",
                    "username": "사나",
                    "backgroundColor": "#a9e34b",
                    "textColor": "#ffffff",
                    "allDay": true
                }, {
                    "id": 8,
                    "title": "세차예약",
                    "description": "Lorem ipsum dolor sit incid idunt ut Lorem ipsum sit.",
                    "start": "2021-06-24T09:00",
                    "end": "2021-06-24T10:00",
                    "type": "카테고리3",
                    "username": "정연",
                    "backgroundColor": "#4d638c",
                    "textColor": "#ffffff",
                    "allDay": false
                }, {
                    "id": 9,
                    "title": "출장",
                    "description": "Lorem ipsum dolor sit incid idunt ut Lorem ipsum sit.",
                    "start": "2021-06-28",
                    "end": "2021-06-31",
                    "type": "카테고리3",
                    "username": "정연",
                    "backgroundColor": "#495057",
                    "textColor": "#ffffff",
                    "allDay": true
                }, {
                    "id": 10,
                    "title": "접수 기간",
                    "description": "Lorem ipsum dolor sit incid idunt ut Lorem ipsum sit.",
                    "start": "2021-06-15",
                    "end": "2021-06-22",
                    "type": "카테고리2",
                    "username": "다현",
                    "backgroundColor": "#9775fa",
                    "textColor": "#ffffff",
                    "allDay": true
                }],
                drop: function (arg) {
                    console.log(arg.dateStr);
                    console.log(arg.draggedEl.innerText.substr(0, 3).trim());
                    if (document.getElementById('drop-remove').checked) {
                        arg.draggedEl.parentNode.removeChild(arg.draggedEl);
                    }
                },
                eventDrop: function (event, delta, revertFunc, jsEvent, ui, view, arg) {
                    // console.log(event.el.innerText.substr(0, 3).trim());
                    // console.log(event.all);
                    // console.log(arg.draggedEl);
                    // console.log(arg.draggedEl.innerText.substr(0, 3).trim());
                    //주,일 view일때 종일 <-> 시간 변경불가
                    // if (view.type === 'agendaWeek' || view.type === 'agendaDay') {
                    //     if (draggedEventIsAllDay !== event.allDay) {
                    //         alert('드래그앤드롭으로 종일<->시간 변경은 불가합니다.');
                    //         location.reload();
                    //         return false;
                    //     }
                    // }
                    //
                    // // 드랍시 수정된 날짜반영

                    console.log(event.event.start.toISOString());
                    console.log(event.event.title);

                    var newDates = calDateWhenDragnDrop(event);
                    // $.ajax({
                    //     type: "get",
                    //     url: "",
                    //     data: {
                    //         //...
                    //     },
                    //     success: function (response) {
                    //         alert('수정: ' + newDates.startDate + ' ~ ' + newDates.endDate);
                    //     }
                    // });

                }
                // events: function (start, end, timezone, callback) {
                //     $.ajax({
                //         type: "get",
                //         url: "data.json",
                //         data: {
                //             // 화면이 바뀌면 Date 객체인 start, end 가 들어옴
                //             //startDate : moment(start).format('YYYY-MM-DD'),
                //             //endDate   : moment(end).format('YYYY-MM-DD')
                //         },
                //         success: function (response) {
                //             var fixedDate = response.map(function (array) {
                //                 if (array.allDay && array.start !== array.end) {
                //                     array.end = moment(array.end).add(1, 'days'); // 이틀 이상 AllDay 일정인 경우 달력에 표기시 하루를 더해야 정상출력
                //                 }
                //                 return array;
                //             });
                //             callback(fixedDate);
                //         }
                //     });
                // },
            });
            calendar.render();
        </script>
    </th:block>
</th:block>
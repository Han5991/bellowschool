<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/basic :: setContent(~{this::content} )}">
    <th:block th:fragment="content">
        <link href="css/Fullcalendar.css" rel="stylesheet">
        <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.js"></script>
        <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.min.js"></script>
        <div class="container-fluid">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h3 class="m-0 font-weight-bold text-primary">시간표 등록</h3>
                </div>
                <div class="card-body">
                    <div id='wrap'>
                        <div id='external-events'>
                            <h4>풀무야간학교 반</h4>
                            <div id='external-events-list' style="width: 10%">
                                <div class='fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event'
                                     th:each="class : ${classList}">
                                    <div class='fc-event-main'
                                         th:text="${class.classtype} + ' : '+ ${class.starttime}+' ~ '+${class.endtime}"></div>
                                </div>
                            </div>
                        </div>
                        <p>
                            <input type='checkbox' id='drop-remove'/>
                            <label for='drop-remove'>remove after drop</label>
                        </p>
                        <div id='calendar-wrap'>
                            <div id='calendar'></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 일정 추가 MODAL -->
        <div class="modal add" tabindex="-1" role="dialog" id="eventModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title"></h4>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit-id">
                        <div class="row">
                            <div class="col-xl-12">
                                <label class="row-cols-xl-6" for="edit-allDay">하루종일</label>
                                <input class='allDayNewEvent' id="edit-allDay" type="checkbox" onchange=""></label>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xl-12">
                                <label class="row-cols-xl-6" for="edit-title">일정명</label>
                                <input class="inputModal" type="text" id="edit-title"
                                       required="required"/>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xl-12">
                                <label class="row-cols-xl-6" for="edit-start-time">시작</label>
                                <input class="inputModal row-cols-xl-6" type="date" id="edit-start-date"/>
                                <input class="inputModal row-cols-xl-6" type="time" id="edit-start-time" step="1800"/>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xl-12">
                                <label class="row-cols-xl-6" for="edit-end-time">끝</label>
                                <input class="inputModal row-cols-xl-6" type="date" id="edit-end-date"/>
                                <input class="inputModal row-cols-xl-6" type="time" id="edit-end-time" step="1800"/>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xl-12">
                                <label for="edit-type" class="row-cols-xl-6">구분</label>
                                <select class="inputModal" type="text" id="edit-type">
                                    <option value="0">카테고리1</option>
                                    <option value="1">카테고리2</option>
                                    <option value="2">카테고리3</option>
                                    <option value="3">카테고리4</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xl-12">
                                <label class="row-cols-xl-6" for="edit-color">색상</label>
                                <select class="inputModal" name="color" id="edit-color">
                                    <option value="#D25565" style="color:#D25565;">빨간색</option>
                                    <option value="#9775fa" style="color:#9775fa;">보라색</option>
                                    <option value="#ffa94d" style="color:#ffa94d;">주황색</option>
                                    <option value="#74c0fc" style="color:#74c0fc;">파란색</option>
                                    <option value="#f06595" style="color:#f06595;">핑크색</option>
                                    <option value="#63e6be" style="color:#63e6be;">연두색</option>
                                    <option value="#a9e34b" style="color:#a9e34b;">초록색</option>
                                    <option value="#4d638c" style="color:#4d638c;">남색</option>
                                    <option value="#495057" style="color:#495057;">검정색</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xl-12">
                                <label class="row-cols-xl-6" for="edit-desc">설명</label>
                                <textarea rows="4" cols="50" class="inputModal"
                                          id="edit-desc" style="resize: none"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer modalBtnContainer-addEvent">
                        <button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
                        <button type="button" class="btn btn-primary" id="save-event" onclick="regSchedule()">저장
                        </button>
                    </div>
                    <div class="modal-footer modalBtnContainer-modifyEvent">
                        <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
                        <button type="button" class="btn btn-danger" id="delete-Event" onclick="deleteSchedule()">삭제
                        </button>
                        <button type="button" class="btn btn-primary" id="update-Event" onclick="updateSchedule()">저장
                        </button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
            <div class="tooltiptopicevent">

            </div>
        </div><!-- /.modal -->

        <script src="js/Fullcalendar.js"></script>
        <script>
            function date(date, time) {
                if (time == '') {
                    return date
                } else {
                    return date + "T" + time;
                }
            }

            function paramsReset() {
                $("#edit-id").val('');
                $('#edit-title').val('');
                $('#edit-desc').val('');

                // $('#edit-start-date').val('');
                // $('#edit-start-time').val('');
                // $('#edit-start-date').val('');
                // $('#edit-start-time').val('');

                $('#edit-type').val('0');
                $('#edit-color').val('#D25565');
                $('#edit-allDay').prop("checked", false);
            }

            function regSchedule() {
                if (confirm("정말 등록하시겠습니까?") == true) {
                    if ($('#edit-title').val() != "") {
                        $.ajax({
                            url: '/regschedule',
                            type: 'POST',
                            contentType: "application/json",
                            data: JSON.stringify({
                                title: $('#edit-title').val(),
                                description: $('#edit-desc').val(),
                                start: date($('#edit-start-date').val(), $('#edit-start-time').val()),
                                end: date($('#edit-end-date').val(), $('#edit-end-time').val()),
                                type: $('#edit-type').val(),
                                username: '관리자',
                                backgroundcolor: $('#edit-color').val(),
                                allday: $('#edit-allDay').is(":checked") ? 'true' : 'false',
                            }),
                            success: function onData(data) {
                                if (data >= 1) {
                                    alert('등록 되었습니다.');
                                    $('.add').modal("hide");
                                    calendar.refetchEvents();
                                } else if (data == 0) {
                                    alert('실패하였습니다.');
                                }
                            }
                        });
                    }
                }
                paramsReset();
            }

            function updateSchedule() {
                if (confirm("정말 수정하시겠습니까?") == true) {
                    if ($('#edit-title').val() != "") {
                        $.ajax({
                            url: '/updateschedule',
                            type: 'POST',
                            contentType: "application/json",
                            data: JSON.stringify({
                                id: $('#edit-id').val(),
                                title: $('#edit-title').val(),
                                description: $('#edit-desc').val(),
                                start: date($('#edit-start-date').val(), $('#edit-start-time').val()),
                                end: date($('#edit-end-date').val(), $('#edit-end-time').val()),
                                type: $('#edit-type').val(),
                                username: '관리자',
                                backgroundcolor: $('#edit-color').val(),
                                allday: $('#edit-allDay').is(":checked") ? 'true' : 'false',
                            }),
                            success: function onData(data) {
                                if (data >= 1) {
                                    alert('등록 되었습니다.');
                                    $('.add').modal("hide");
                                    calendar.refetchEvents();
                                } else if (data == 0) {
                                    alert('실패하였습니다.');
                                }
                            }
                        });
                    }
                }
                paramsReset();
            }

            function deleteSchedule() {
                if (confirm("정말 삭제하시겠습니까?") == true) {
                    if ($('#edit-title').val() != "") {
                        $.ajax({
                            url: '/deleteschedule',
                            type: 'POST',
                            contentType: "application/json",
                            data: JSON.stringify({
                                id: $('#edit-id').val()
                            }),
                            success: function onData(data) {
                                if (data >= 1) {
                                    alert('삭제 되었습니다.');
                                    $('.add').modal("hide");
                                    calendar.refetchEvents();
                                    paramsReset();
                                } else if (data == 0) {
                                    alert('실패하였습니다.');
                                }
                            }
                        });
                    }
                }
                paramsReset();
            }

            const containerEl = $('#external-events-list')[0];
            new FullCalendar.Draggable(containerEl, {
                itemSelector: '.fc-event',
                eventData: function (eventEl) {
                    return {
                        title: eventEl.innerText.trim()
                    }
                }
            });

            const calendarEl = $('#calendar')[0];
            const calendar = new FullCalendar.Calendar(calendarEl, {
                locale: "ko",
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                editable: true,
                droppable: true,
                contentHeight: 'auto',
                selectable: true,
                dateClick: function (info) {
                    $('#edit-start-date').val(info.dateStr);
                    $(".add").modal('show');
                    $(".modalBtnContainer-modifyEvent").hide();
                    $(".modalBtnContainer-addEvent").show();
                },
                eventClick: function (event) {
                    $('#edit-id').val(event.event.id);
                    $('#edit-title').val(event.event.title);
                    $('#edit-desc').val(event.event.extendedProps.description);

                    $('#edit-start-date').val(event.event.startStr.substr(0, 10));
                    $('#edit-start-time').val(event.event.startStr.substr(11, 5));
                    $('#edit-end-date').val(event.event.endStr.substr(0, 10));
                    $('#edit-end-time').val(event.event.endStr.substr(11, 5));
                    $('#edit-type').val(event.event.extendedProps.type);
                    $('#edit-color').val(event.event.backgroundColor);
                    $('#edit-allDay').prop("checked", event.event.extendedProps.allday);

                    $(".add").modal('show');
                    $(".modalBtnContainer-modifyEvent").show();
                    $(".modalBtnContainer-addEvent").hide();
                },
                droppable: true,
                drop: function (arg, info) {
                    console.log(info.dateStr);
                    // is the "remove after drop" checkbox checked?
                    if (document.getElementById('drop-remove').checked) {
                        // if so, remove the element from the "Draggable Events" list
                        arg.draggedEl.parentNode.removeChild(arg.draggedEl);
                    }
                },
                drop: function (arg) {
                    console.log(arg.dateStr);
                    console.log(arg.draggedEl.innerText.substr(0, 3).trim());
                    if (document.getElementById('drop-remove').checked) {
                        arg.draggedEl.parentNode.removeChild(arg.draggedEl);
                    }
                },
                eventDrop: function (event, delta, revertFunc, jsEvent, ui, view, arg) {
                    // console.log(event.el.innerText.substr(0, 3).trim());
                    // console.log(event.all);
                    // console.log(arg.draggedEl);
                    // console.log(arg.draggedEl.innerText.substr(0, 3).trim());
                    //데이터 이동 시 호출
                    console.log(event.event.start.toISOString());
                    console.log(event.event.title);
                },
                events: {
                    url: '/scheduleList',
                    method: 'POST',
                    failure: function () {
                        alert('스케줄을 가져오지 못 했습니다.');
                    }
                    // color: 'yellow',   // a non-ajax option
                    // textColor: 'black' // a non-ajax option
                },
                eventSourceSuccess: function (content, xhr) {
                    //여기서 수정 가능
                    content.forEach(function (element) {
                        // console.log(element.title);
                    });
                    return content;
                },
                eventMouseEnter: function (info) {
                    tippy(info.el, {
                        content:  info.event.extendedProps.description//이벤트 디스크립션을 툴팁으로 가져옵니다.
                    });
                }
            });
            calendar.render();
        </script>
    </th:block>
</th:block>